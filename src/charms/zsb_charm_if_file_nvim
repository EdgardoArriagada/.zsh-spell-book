#!/usr/bin/env zsh
set -o errexit
set -o pipefail


# (tightly coupled with tmux config, ripgrep, and nvim)
# for tmux conf, see https://github.com/EdgardoArriagada/dotFiles/blob/main/tmux/home/.tmux.conf

function loadFile() {
  # cargo
  export PATH=$PATH:~/.cargo/bin
  # fnm
  eval "$(fnm env --use-on-cd)"

  case $# in
    1) nvim ${1} ;;
    2) nvim ${1} +${2} ;;
  esac
}

local lines=( ${(s.ยง.)"${@}"} )
local cursorLine=${lines[$#lines]}

if [[ -f ${cursorLine} ]]
  then loadFile ${cursorLine}; exit 0
fi

function findFileIndex() {
  local i=0
  for line in "${lines[@]}"; do
    : $((i++))
    if [[ -f ${line} ]]; then
      printf ${i}
      return
    fi
  done
  printf "Err"
}

local fileIndex=`findFileIndex`

if [[ ${fileIndex} == "Err" ]]
  then exit 1
fi

# get number out of first number until ':' in a line using param expansion
local lineNumber=${cursorLine%%:*}

# if its a valid number, open the file
if [[ "$lineNumber" = <-> ]]
  then loadFile ${lines[${fileIndex}]} ${lineNumber}; exit 0
fi

exit 1
