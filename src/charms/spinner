#!/bin/bash

declare msg="\e[38;5;8m${@}\033[0m"
declare finished=false

function makeCursorVisible() {
  tput cnorm
}

function makeCursorInvisible() {
  tput civis
}

function shutdown() {
  makeCursorVisible
  ! "$finished" && printf "\r! ${msg}"
}

trap shutdown EXIT

function spinner() {
  local LC_CTYPE=C # spinner does noe behave weird

  local pid=$1 # Process Id of the previous running command
  shift 1
  local spin='⣾⣽⣻⢿⡿⣟⣯⣷'
  local charwidth=3

  makeCursorInvisible

  printf "  ${msg}"

  local i=0
  while kill -0 $pid 2>/dev/null; do
    local i=$(((i + $charwidth) % ${#spin}))
    printf "\r${spin:$i:$charwidth}"

    sleep .1
  done


  wait $pid # capture exit code
  local exitCode=$?
  finished=true
  if (( $exitCode )); then
    printf "\r\e[38;5;1m✘\033[0m\n"
  else
    printf "\r\e[38;5;2m✔\033[0m\n"
  fi

  makeCursorVisible
  return $exitCode
}

("$@") &

spinner $! "$@"
